name: Release

on:
  workflow_call:
    inputs:
      CHARTS_DIR:
        description: Directory containing the Helm charts
        type: string
        required: false
        default: ./charts
      HELM_REPOS:
        description: Helm repositories to add (name=url, comma-separated)
        type: string
        required: false

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create new release
    runs-on: ubuntu-latest
    steps:
    - name: Checks-out repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name github-actions[bot]
        git config user.email github-actions[bot]@users.noreply.github.com

    - name: Install Helm
      uses: azure/setup-helm@v4

    - name: Add Helm repos
      run: |
        for repo in $(echo "${{ inputs.HELM_REPOS }}" | tr ',' '\n'); do
          NAME="${repo%%=*}"
          URL="${repo#*=}"
          helm repo add "$NAME" "$URL"
        done
        helm repo update

    - name: Run chart-releaser
      id: chart-releaser
      uses: helm/chart-releaser-action@v1
      with:
        charts_dir: ${{ inputs.CHARTS_DIR }}
        skip_upload: true
        packages_with_index: false
        pages_branch: ""
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      
    - name: Login to GitHub Container Registry
      if: steps.chart-releaser.outputs.changed_charts != ''
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Publish and sign charts to OCI registry
      if: steps.chart-releaser.outputs.changed_charts != ''
      run: |
        # Only process charts that were actually released
        for chart_package in .cr-release-packages/*.tgz; do
          if [ ! -f "$chart_package" ]; then
            echo "No charts to publish"
            continue
          fi
          
          chart_file=$(basename "$chart_package")
          
          # Push to GHCR
          echo "Publishing ${chart_file} to OCI registry..."
          helm push "$chart_package" oci://ghcr.io/${{ github.repository }}
        done
