name: Release

on:
  workflow_call:
    inputs:
      CHARTS_DIR:
        description: Directory containing the Helm charts
        type: string
        required: false
        default: ./charts
      HELM_REPOS:
        description: Helm repositories to add (name=url, comma-separated)
        type: string
        required: false

permissions:
  contents: write

jobs:
  release:
    name: Create new release
    runs-on: ubuntu-latest
    steps:
    - name: Checks-out repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name github-actions[bot]
        git config user.email github-actions[bot]@users.noreply.github.com

    - name: Install Helm
      uses: azure/setup-helm@v4

    - name: Add Helm repos
      run: |
        for repo in $(echo "${{ inputs.HELM_REPOS }}" | tr ',' '\n'); do
          NAME="${repo%%=*}"
          URL="${repo#*=}"
          helm repo add "$NAME" "$URL"
        done
        helm repo update

    - name: Run chart-releaser
      uses: helm/chart-releaser-action@v1
      with:
        charts_dir: ${{ inputs.CHARTS_DIR }}
      env:
        CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
