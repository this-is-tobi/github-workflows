name: Trivy scan

on:
  workflow_call:
    inputs:
      IMAGE:
        description: Image used to perform scan (eg. docker.io/debian:latest)
        required: false
        type: string
      REGISTRY_USERNAME:
        description: Username used to login into registry
        required: false
        type: string
      REGISTRY_PASSWORD:
        description: Password used to login into registry
        required: false
        type: string

      PATH:
        description: Path used to perform scan
        required: false
        type: string
      FORMAT:
        description: Format of the report (sarif, table, json, ...)
        required: false
        type: string
        default: table
      PR_NUMBER:
        description: Whether the caller workflow is triggered by a pull request
        required: false
        type: string
      GITHUB_SECURITY_TAB:
        description: Whether to link to GitHub Security Tab in the PR comment
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  security-events: write
  pull-requests: write
  packages: read

jobs:
  images-scan:
    name: Scan images vulnerabilities
    if: ${{ inputs.IMAGE != '' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checks-out repository
      uses: actions/checkout@v5

    - name: Run Trivy vulnerability scanner on images
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: "${{ inputs.IMAGE }}"
        format: ${{ inputs.FORMAT }}
        vuln-type: "os,library"
        ignore-unfixed: true
        output: ${{ format('trivy-results.{0}', inputs.FORMAT) }}
        github-pat: ${{ github.token }}
      env:
        TRIVY_USERNAME: ${{ startsWith(inputs.IMAGE, 'ghcr.io') && github.actor || inputs.REGISTRY_USERNAME }}
        TRIVY_PASSWORD: ${{ startsWith(inputs.IMAGE, 'ghcr.io') && github.token || inputs.REGISTRY_PASSWORD }}
      continue-on-error: true

    - name: Print Trivy scan results
      if: ${{ inputs.FORMAT == 'table' }}
      run: |
        echo "## Trivy Scan Results for image '${{ inputs.IMAGE }}'" >> $GITHUB_STEP_SUMMARY
        echo '---' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat ${{ format('trivy-results.{0}', inputs.FORMAT) }} >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: ${{ inputs.GITHUB_SECURITY_TAB && inputs.FORMAT == 'sarif' }}
      with:
        sarif_file: ${{ format('trivy-results.{0}', inputs.FORMAT) }}
      continue-on-error: true

    - name: Warn about error
      if: failure()
      run: |
        echo ":warning: The Trivy scan report for image `${{ inputs.IMAGE }}` was not successfully completed and could not be uploaded to the Github Security Panel." >> $GITHUB_STEP_SUMMARY

  config-scan:
    name: Scan config files vulnerabilities
    if: ${{ inputs.PATH != '' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checks-out repository
      uses: actions/checkout@v5

    - name: Run Trivy vulnerability scanner on config files
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-ref: "${{ inputs.PATH }}"
        scan-type: config
        format: ${{ inputs.FORMAT }}
        skip-dirs: "**/node_modules"
        ignore-unfixed: true
        output: ${{ format('trivy-results.{0}', inputs.FORMAT) }}
        github-pat: ${{ github.token }}
      continue-on-error: true

    - name: Print Trivy scan results
      if: ${{ inputs.FORMAT == 'table' }}
      run: |
        echo "## Trivy Scan Results for path '${{ inputs.PATH }}'" >> $GITHUB_STEP_SUMMARY
        echo '---' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat ${{ format('trivy-results.{0}', inputs.FORMAT) }} >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: ${{ inputs.GITHUB_SECURITY_TAB && inputs.FORMAT == 'sarif' }}
      with:
        sarif_file: ${{ format('trivy-results.{0}', inputs.FORMAT) }}
      continue-on-error: true

    - name: Warn about error
      if: failure()
      run: |
        echo ":warning: The Trivy scan report for configuration was not successfully completed and could not be uploaded to the Github Security Panel." >> $GITHUB_STEP_SUMMARY

  scan-notif:
    name: Notify users
    runs-on: ubuntu-latest
    if: ${{ always() && (needs.images-scan.result == 'success' || needs.config-scan.result == 'success') }}
    needs:
    - images-scan
    - config-scan
    steps:
    - name: Comment PR
      uses: thollander/actions-comment-pull-request@v3
      if: ${{ inputs.PR_NUMBER != '' }}
      with:
        message: |
          ðŸ¤– Hey !

          The security scan report for the current pull request is available in ${{ (inputs.GITHUB_SECURITY_TAB && inputs.FORMAT == 'sarif') && format('[the GitHub Security Tab](https://github.com/{0}/security/code-scanning?query=is%3Aopen+branch%3A{1}+pr%3A{2})', github.repository, github.ref_name, (github.event.pull_request.number || github.event.number)) || format('[the GitHub Workflow Summary](https://github.com/{0}/actions/runs/{1})', github.repository, github.run_id) }}.
        comment-tag: vuln-scan
        pr-number: ${{ inputs.PR_NUMBER }}